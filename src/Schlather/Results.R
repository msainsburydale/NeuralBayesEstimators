source("src/PlottingFunctions.R")

model <- "Schlather"
intermediates_path  <- paste0("intermediates/", model, "/")
estimates_path      <- paste0(intermediates_path, "Estimates/")
img_path            <- paste0("img/", model)

# NB: Order of this list gives the order of the facets in the risk plots
param_labels <- c(
  "ρ"  = expression(rho),
  "ν"  = expression(nu)
)

# Subset of estimators
estimators <- c("N_m1",  "ND_piecewise", "PL3")

# ---- Variable sample size ----

# Load in estimates + true parameters
df     <- estimates_path %>% paste0("merged_test.csv") %>% read.csv
likelihood_path <- paste0(estimates_path, "merged_likelihood_test.csv")
if (file.exists(likelihood_path)) df <- rbind(df, read.csv(likelihood_path))

all_loss <- c("MAE", "RMSE", "MSE", "MAD", "zeroone")

risk_plots <- lapply(all_loss, function(loss) {

  gg <- df %>%
    filter(estimator %in% estimators) %>%
    diagnosticplot(param_labels, loss = eval(parse(text = loss))) +
    theme(
      strip.text = element_text(size = 17),
      axis.title = element_text(size = 17),
      axis.text = element_text(size = 15)
    )

  # ggsave(
  #   gg, width = 8, height = 4, device = "pdf", path = img_path,
  #   file = paste0(loss, "_vs_m.pdf"),
  # )

  gg
})

names(risk_plots) <- all_loss
risk_plot <- risk_plots[["zeroone"]]


# ---- Joint distribution ----

# Load in estimates + true parameters
df     <- estimates_path %>% paste0("merged_scenarios.csv") %>% read.csv
likelihood_path <- paste0(estimates_path, "merged_likelihood_scenarios.csv")
if (file.exists(likelihood_path)) df <- rbind(df, read.csv(likelihood_path))

all_m  <- unique(df$m)

x <- lapply(all_m, function(i) {

  # filter the estimates to only a subset of m and estimators
  df <- df %>% filter(m == i, estimator %in% estimators, k <= 4)

  figure <- scatterplotlong(df, param_labels) + facet_wrap(k ~ ., scales = "free", nrow = 1)

  ggsave(figure,
         file = str_interp("Scatterplot_m${i}.pdf"), device = "pdf",
         width = 10, height = 3, path = img_path)
})

# ---- Single joint distribution ----

estimates_plot <- df %>%
  filter(m == 150, k == 1, estimator %in% estimators) %>%
  scatterplotlong(param_labels)


# ---- Combined risk and scatter plot ----

# To align the top border of the panels, we use a blank title and change its size appropriately
blank_title   <- function(gg) gg + labs(title = " ") + theme(plot.title = element_text(size = 18))

# Change elements of the plots to make it easier to read
increase_font <- function(gg) gg + theme(axis.title = element_text(size = 17), axis.text = element_text(size = 15))
strip_size <- 17

risk_plot <- (risk_plot + theme(strip.text = element_text(size = strip_size))) %>% increase_font
estimates_plot <- estimates_plot %>% blank_title %>% increase_font

ggsave(
  ggarrange(risk_plot, estimates_plot,
            common.legend = TRUE, legend = "right", widths = c(2, 1)),
  file = str_interp("risk_and_scatterplot.pdf"), device = "pdf",
  width = 12, height = 4, path = img_path
)


# ---- Field plot ----

# We show the simulations from Schlather's model in the supplementary material,
# so here we generate a figure that looks nicer than that generated by
# VisualiseRealisations.R

fields <- paste0(intermediates_path, "fields.csv") %>% read.csv
scenarios <- c(1, 2, 3)

# Visualise the fields
fieldplots <- lapply(scenarios, function(j) plot_fields(fields %>% filter(scenario == j)))
ggsave(ggarrange(plotlist = fieldplots, ncol = 1),
       file = "fields_subset.pdf", device = "pdf",
       width = 12, height = 14, path = img_path)



# ---- All PL functions ----

# NB The following code is used to generate Figure S12 of the
#    Supplementary Material (which illustrates the line search for the fixed
#    cut-off distance, d). 

estimator_labels["PL3"] <- expression(PL[3])

# Load in estimates + true parameters
likelihood_path <- paste0(estimates_path, "merged_likelihood_test_allpairwise.csv")
if (file.exists(likelihood_path)) {

  df <- read.csv(likelihood_path)

  risk_plots <- lapply(all_loss, function(loss) {

    gg <- df %>%
      diagnosticplot(param_labels, loss = eval(parse(text = loss))) +
      theme(
        strip.text = element_text(size = 17),
        axis.title = element_text(size = 17),
        axis.text = element_text(size = 15)
      )

    ggsave(
      gg, width = 8, height = 4, device = "pdf", path = img_path,
      file = paste0(loss, "_vs_m_allpairwise.pdf"),
    )

    gg
  })

}